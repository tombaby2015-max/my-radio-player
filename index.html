<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Radio</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: #111;
    color: #fff;
  }
  
  .header-fixed {
    position: sticky;
    top: 0;
    background: #111;
    z-index: 50;
    padding: 10px 0 5px;
    border-bottom: 1px solid #222;
  }
  
  .header-top {
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  h1 {
    text-align: center;
    font-size: 20px;
    margin: 0 0 5px 0;
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 300;
    color: #fff;
  }
  
  .version {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    font-size: 14px;
    color: #666;
    margin-left: 5px;
  }
  
  .sleep-timer-btn {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .sleep-timer-btn img {
    width: 28px;
    height: 28px;
    filter: invert(1);
  }
  
  .status-bar {
    text-align: center;
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
  }
  
  .separator {
    margin: 0 8px;
    color: #444;
  }

  .timer-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  .timer-content {
    background: #1c1c1c;
    padding: 25px;
    border-radius: 20px;
    width: 280px;
    text-align: center;
  }

  .timer-title {
    font-size: 18px;
    margin-bottom: 20px;
    color: #fff;
  }

  .time-selector {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 25px;
  }

  .time-column {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .time-label {
    font-size: 12px;
    color: #888;
    margin-bottom: 10px;
  }

  .time-scroll {
    height: 120px;
    width: 60px;
    overflow: hidden;
    border: 1px solid #444;
    border-radius: 10px;
    background: #2a2a2a;
    position: relative;
  }

  .time-list {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .time-item {
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #888;
    width: 100%;
  }

  .time-item.active {
    color: #fff;
    font-weight: bold;
  }

  .timer-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .timer-action-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
  }

  .timer-set {
    background: #0a84ff;
    color: white;
  }

  .timer-cancel {
    background: #444;
    color: white;
  }

  .timer-stop {
    background: #ff3b30;
    color: white;
  }

  .grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 16px;
    padding: 12px;
    max-width: 320px;
    margin: 0 auto;
  }
  .card {
    width: 140px;
    background: #1c1c1c;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    text-align: center;
    border: 4px solid #000;
    box-sizing: border-box;
    cursor: pointer;
    transition: border-color 0.3s;
    position: relative;
  }
  .card.active {
    border-color: #ff3b30;
  }
  .card img {
    width: 100%;
    height: 140px;
    border-radius: 12px;
    object-fit: cover;
  }
  .edit-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    cursor: pointer;
    z-index: 10;
  }
  .add-card {
    border: 2px dashed #444;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: #666;
    background: transparent;
  }
  .add-card:hover {
    border-color: #888;
    color: #888;
  }
  
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: #1c1c1c;
    padding: 20px;
    border-radius: 16px;
    width: 300px;
    max-width: 90%;
  }
  .modal h2 {
    margin-top: 0;
    text-align: center;
  }
  .form-group {
    margin-bottom: 15px;
  }
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
  }
  .form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #444;
    border-radius: 8px;
    background: #2a2a2a;
    color: white;
    box-sizing: border-box;
  }
  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  .btn-primary {
    background: #0a84ff;
    color: white;
  }
  .btn-secondary {
    background: #444;
    color: white;
  }
  .btn-danger {
    background: #ff3b30;
    color: white;
  }
  .loading {
    text-align: center;
    color: #888;
    padding: 20px;
  }
</style>
</head>
<body>
  <div class="header-fixed">
    <div class="header-top">
      <h1>My Radio <span class="version">v1.2</span></h1>
      <div class="sleep-timer-btn" id="sleepTimerBtn" onclick="openTimerModal()">
        <img src="https://png.pngtree.com/png-vector/20191005/ourlarge/pngtree-beautiful-alarm-clock-vector-line-icon-png-image_1795315.jpg" alt="Таймер" onerror="this.style.display='none'; this.parentElement.innerHTML='⏰';">
      </div>
    </div>
    <div class="status-bar">
      <span id="syncStatus">синхронизировано</span>
      <span class="separator">/</span>
      <span id="playStatus">остановлено</span>
    </div>
  </div>

  <div class="grid" id="stationsGrid">
    <div class="loading">Загрузка радиостанций...</div>
  </div>

  <!-- Модальное окно таймера -->
  <div class="timer-modal" id="timerModal">
    <div class="timer-content">
      <div class="timer-title" id="timerModalTitle">Таймер сна</div>
      <div class="time-selector">
        <div class="time-column">
          <div class="time-label">Часы</div>
          <div class="time-scroll" id="hoursScroll">
            <div class="time-list" id="hoursList"></div>
          </div>
        </div>
        <div class="time-column">
          <div class="time-label">Минуты</div>
          <div class="time-scroll" id="minutesScroll">
            <div class="time-list" id="minutesList"></div>
          </div>
        </div>
      </div>
      <div class="timer-actions" id="timerActions">
        <button class="timer-action-btn timer-cancel" onclick="closeTimerModal()">Отмена</button>
        <button class="timer-action-btn timer-set" onclick="setCustomTimer()">Установить</button>
      </div>
      <div class="timer-actions" id="timerStopAction" style="display: none; margin-top: 10px;">
        <button class="timer-action-btn timer-stop" onclick="stopSleepTimer()">Остановить таймер</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно редактирования станций -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h2 id="modalTitle">Добавить радиостанцию</h2>
      <div class="form-group">
        <label for="stationName">Название станции *</label>
        <input type="text" id="stationName" required>
      </div>
      <div class="form-group">
        <label for="stationImage">URL изображения</label>
        <input type="text" id="stationImage" placeholder="https://example.com/image.jpg">
      </div>
      <div class="form-group">
        <label for="stationUrl">URL аудиопотока *</label>
        <input type="text" id="stationUrl" required placeholder="https://example.com/stream.m3u8">
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Отмена</button>
        <button class="btn btn-danger" id="deleteBtn" style="display:none" onclick="deleteStation()">Удалить</button>
        <button class="btn btn-primary" onclick="saveStation()">Сохранить</button>
      </div>
    </div>
  </div>

  <video id="player" preload="none" playsinline webkit-playsinline></video>

<script>
  // Конфигурация JSONBin
  const JSONBIN_BIN_ID = '68daac46ae596e708f001aca';
  const JSONBIN_API_KEY = '$2a$10$3RWbk8Hlfsp34qpkemmhS.il8iMVgaGFvSvy2hn6TIpz4Irf1csdu';
  
  // Глобальные переменные
  var player = document.getElementById('player');
  var stationsGrid = document.getElementById('stationsGrid');
  var editModal = document.getElementById('editModal');
  var modalTitle = document.getElementById('modalTitle');
  var deleteBtn = document.getElementById('deleteBtn');
  var timerModal = document.getElementById('timerModal');
  var sleepTimerBtn = document.getElementById('sleepTimerBtn');
  var timerModalTitle = document.getElementById('timerModalTitle');
  var timerActions = document.getElementById('timerActions');
  var timerStopAction = document.getElementById('timerStopAction');
  
  var currentActiveCard = null;
  var currentStationUrl = null;
  var editingIndex = -1;
  var stations = [];
  var hls = null;
  var sleepTimer = null;
  var sleepEndTime = null;

  // Начальные станции
  var defaultStations = [
    {
      name: "SoundPark Deep",
      image: "https://yt3.googleusercontent.com/ytc/AIdro_lJTw4VkYle3-UEtE-IA7sni1SyTx9Uqvxp10UvSHRMIqk=s900-c-k-c0x00ffffff-no-rj",
      url: "https://h.getradio.me/spdeep/hls.m3u8"
    },
    {
      name: "Svoe FM",
      image: "https://static10.tgstat.ru/channels/_0/f9/f9d9076a2feff054391254eb50e2794f.jpg",
      url: "https://h.getradio.me/svoefm/hls.m3u8"
    },
    {
      name: "Best Deep FM",
      image: "https://static.tildacdn.com/tild3431-6236-4139-b533-326566616136/Original12_2.png",
      url: "https://h.getradio.me/bestdeepfm/hls.m3u8"
    },
    {
      name: "Luxury Music DeepH",
      image: "https://yt3.googleusercontent.com/ytc/AIdro_mcxZehF6Fv0yPccj0nnnhcvRbxlNrC1EhlodWWZ-KWArI=s900-c-k-c0x00ffffff-no-rj",
      url: "https://h.getradio.me/luxury/hls.m3u8"
    },
    {
      name: "Delish Deep",
      image: "https://avatars.mds.yandex.net/i?id=ef3d0278cc7b1a792a5677b4d61de256_l-5209794-images-thumbs&n=13",
      url: "https://h.getradio.me/delishdeep/hls.m3u8"
    }
  ];

  // Простая инициализация селектора времени с зацикливанием
  function initTimeSelector() {
    const hoursList = document.getElementById('hoursList');
    const minutesList = document.getElementById('minutesList');
    
    // Очищаем списки
    hoursList.innerHTML = '';
    minutesList.innerHTML = '';
    
    // Часы - создаем больше элементов для зацикливания
    for (let i = 0; i < 100; i++) {
      const hourItem = document.createElement('div');
      hourItem.className = 'time-item';
      hourItem.textContent = i % 24;
      hourItem.dataset.value = i % 24;
      hoursList.appendChild(hourItem);
    }
    
    // Минуты - создаем больше элементов для зацикливания
    for (let i = 0; i < 100; i++) {
      const minuteItem = document.createElement('div');
      minuteItem.className = 'time-item';
      minuteItem.textContent = (i % 60).toString().padStart(2, '0');
      minuteItem.dataset.value = i % 60;
      minutesList.appendChild(minuteItem);
    }
    
    // Устанавливаем начальное значение 0:00
    setTimeout(() => {
      setTimeSelection(50, 50); // Ставим в середину для зацикливания
    }, 100);
  }

  function setTimeSelection(hoursIndex, minutesIndex) {
    const hoursList = document.getElementById('hoursList');
    const minutesList = document.getElementById('minutesList');
    
    // Сбрасываем активные классы
    const allItems = document.querySelectorAll('.time-item');
    allItems.forEach(item => item.classList.remove('active'));
    
    // Устанавливаем позиции в середину для зацикливания
    hoursList.style.transform = `translateY(${-hoursIndex * 40}px)`;
    minutesList.style.transform = `translateY(${-minutesIndex * 40}px)`;
    
    // Устанавливаем активные элементы
    const activeHourIndex = hoursIndex % 24;
    const activeMinuteIndex = minutesIndex % 60;
    
    if (hoursList.children[hoursIndex]) {
      hoursList.children[hoursIndex].classList.add('active');
    }
    if (minutesList.children[minutesIndex]) {
      minutesList.children[minutesIndex].classList.add('active');
    }
  }

  function getSelectedTime() {
    const activeHour = document.querySelector('#hoursList .time-item.active');
    const activeMinute = document.querySelector('#minutesList .time-item.active');
    
    return {
      hours: activeHour ? parseInt(activeHour.dataset.value) : 0,
      minutes: activeMinute ? parseInt(activeMinute.dataset.value) : 0
    };
  }

  function openTimerModal() {
    timerModal.style.display = 'flex';
    
    // Показываем/скрываем кнопку остановки
    if (sleepTimer) {
      timerModalTitle.textContent = 'Таймер активен';
      timerActions.style.display = 'none';
      timerStopAction.style.display = 'flex';
    } else {
      timerModalTitle.textContent = 'Таймер сна';
      timerActions.style.display = 'flex';
      timerStopAction.style.display = 'none';
      // Устанавливаем 0:00 при каждом открытии
      setTimeSelection(50, 50);
    }
  }

  function closeTimerModal() {
    timerModal.style.display = 'none';
  }

  function setCustomTimer() {
    const time = getSelectedTime();
    const totalMinutes = time.hours * 60 + time.minutes;
    
    if (totalMinutes === 0) {
      clearSleepTimer();
    } else {
      setSleepTimer(totalMinutes);
    }
    
    closeTimerModal();
  }

  function stopSleepTimer() {
    clearSleepTimer();
    closeTimerModal();
  }

  function setSleepTimer(minutes) {
    // Сбрасываем предыдущий таймер
    if (sleepTimer) {
      clearInterval(sleepTimer);
    }
    
    // Устанавливаем время окончания
    sleepEndTime = new Date();
    sleepEndTime.setMinutes(sleepEndTime.getMinutes() + minutes);
    
    // Сохраняем в localStorage
    localStorage.setItem('sleepTimerEnd', sleepEndTime.getTime().toString());
    localStorage.setItem('sleepTimerDuration', minutes.toString());
    
    sleepTimer = setInterval(updateSleepTimerDisplay, 1000);
    updateSleepTimerDisplay();
  }

  // Восстанавливаем таймер при загрузке
  function restoreSleepTimer() {
    const savedEndTime = localStorage.getItem('sleepTimerEnd');
    const savedDuration = localStorage.getItem('sleepTimerDuration');
    
    if (savedEndTime && savedDuration) {
      const endTime = parseInt(savedEndTime);
      const now = new Date().getTime();
      
      if (endTime > now) {
        // Таймер еще активен
        sleepEndTime = new Date(endTime);
        const remainingMinutes = Math.ceil((endTime - now) / 60000);
        setSleepTimer(remainingMinutes);
      } else {
        // Таймер истек
        clearSleepTimerStorage();
      }
    }
  }

  function clearSleepTimer() {
    if (sleepTimer) {
      clearInterval(sleepTimer);
      sleepTimer = null;
    }
    sleepEndTime = null;
    clearSleepTimerStorage();
    
    const timerBtn = document.getElementById('sleepTimerBtn');
    timerBtn.innerHTML = '<img src="https://png.pngtree.com/png-vector/20191005/ourlarge/pngtree-beautiful-alarm-clock-vector-line-icon-png-image_1795315.jpg" alt="Таймер" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'⏰\';">';
  }

  function clearSleepTimerStorage() {
    localStorage.removeItem('sleepTimerEnd');
    localStorage.removeItem('sleepTimerDuration');
  }

  function updateSleepTimerDisplay() {
    if (!sleepEndTime) {
      clearSleepTimer();
      return;
    }
    
    const now = new Date();
    const diff = sleepEndTime - now;
    
    if (diff <= 0) {
      // Время вышло - останавливаем радио
      stopRadio();
      clearSleepTimer();
      return;
    }
    
    const totalMinutes = Math.floor(diff / 60000);
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    
    // Обновляем отображение в кружке
    const timerBtn = document.getElementById('sleepTimerBtn');
    if (hours > 0) {
      timerBtn.innerHTML = hours + ':' + minutes.toString().padStart(2, '0');
    } else if (minutes > 0) {
      timerBtn.innerHTML = minutes + 'm';
    } else {
      const seconds = Math.floor((diff % 60000) / 1000);
      timerBtn.innerHTML = seconds + 's';
    }
  }

  function updatePlayStatus(text) {
    document.getElementById('playStatus').textContent = text;
  }

  function toggleStation(url, name, cardElement) {
    if (currentActiveCard === cardElement) {
      stopRadio();
      return;
    }
    
    stopRadio();
    
    currentActiveCard = cardElement;
    currentStationUrl = url;
    
    cardElement.classList.add('active');
    updatePlayStatus("буферизация...");
    
    if (hls) {
      hls.destroy();
      hls = null;
    }
    
    if (player.canPlayType('application/vnd.apple.mpegurl')) {
      playNativeHLS(url, name, cardElement);
    } else if (Hls.isSupported()) {
      playWithHlsJs(url, name, cardElement);
    } else {
      updatePlayStatus("браузер не поддерживает");
      cardElement.classList.remove('active');
      currentActiveCard = null;
      currentStationUrl = null;
    }
  }

  function playNativeHLS(url, name, cardElement) {
    player.innerHTML = '<source src="'+url+'" type="application/vnd.apple.mpegurl">';
    player.load();
    
    var playPromise = player.play();
    if (playPromise !== undefined) {
      playPromise.then(function() {
        updatePlayStatus("играет: " + name);
      }).catch(function(error) {
        console.error("Ошибка воспроизведения:", error);
        updatePlayStatus("ошибка");
        cardElement.classList.remove('active');
        currentActiveCard = null;
        currentStationUrl = null;
      });
    }
  }

  function playWithHlsJs(url, name, cardElement) {
    updatePlayStatus("подготовка HLS...");
    
    hls = new Hls({
      enableWorker: false,
      lowLatencyMode: true,
      backBufferLength: 90
    });
    
    hls.loadSource(url);
    hls.attachMedia(player);
    
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      var playPromise = player.play();
      if (playPromise !== undefined) {
        playPromise.then(function() {
          updatePlayStatus("играет: " + name);
        }).catch(function(error) {
          console.error("Ошибка воспроизведения HLS.js:", error);
          updatePlayStatus("ошибка воспроизведения");
          cardElement.classList.remove('active');
          currentActiveCard = null;
          currentStationUrl = null;
        });
      }
    });
    
    hls.on(Hls.Events.ERROR, function(event, data) {
      console.error("HLS.js ошибка:", data);
      if (data.fatal) {
        updatePlayStatus("ошибка потока");
        cardElement.classList.remove('active');
        currentActiveCard = null;
        currentStationUrl = null;
      }
    });
  }

  function stopRadio() {
    if (hls) {
      hls.destroy();
      hls = null;
    }
    
    try { 
      player.pause();
      player.currentTime = 0;
    } catch(e) {}
    
    if (currentActiveCard) {
      currentActiveCard.classList.remove('active');
      currentActiveCard = null;
      currentStationUrl = null;
    }
    
    updatePlayStatus("остановлено");
  }

  // Максимально простая загрузка станций для iOS
  function loadStations() {
    try {
      document.getElementById('syncStatus').textContent = "синхронизация...";
      
      // Сначала пробуем локальное хранилище (быстрее для iOS)
      const localStations = localStorage.getItem('radioStations');
      if (localStations) {
        stations = JSON.parse(localStations);
        document.getElementById('syncStatus').textContent = "локальные данные";
        renderStations();
      } else {
        stations = [...defaultStations];
        document.getElementById('syncStatus').textContent = "начальные станции";
        renderStations();
      }
      
      // Затем пробуем загрузить из облака в фоне
      setTimeout(() => {
        fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('Ошибка загрузки');
          return response.json();
        })
        .then(data => {
          if (data.record && data.record.stations && data.record.stations.length > 0) {
            stations = data.record.stations;
            document.getElementById('syncStatus').textContent = "синхронизировано";
            renderStations();
          }
        })
        .catch(error => {
          console.error('Ошибка загрузки из облака:', error);
        });
      }, 1000);
      
    } catch (error) {
      console.error('Критическая ошибка:', error);
      stations = [...defaultStations];
      renderStations();
    }
  }

  function saveStationsToCloud() {
    // Сохраняем локально сразу
    localStorage.setItem('radioStations', JSON.stringify(stations));
    
    // Пытаемся сохранить в облако в фоне
    fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': JSONBIN_API_KEY
      },
      body: JSON.stringify({ stations: stations })
    })
    .catch(error => {
      console.error('Ошибка сохранения в облако:', error);
    });
  }

  function renderStations() {
    if (!stationsGrid) return;
    
    stationsGrid.innerHTML = '';
    
    if (!stations || stations.length === 0) {
      stationsGrid.innerHTML = '<div class="loading">Нет радиостанций</div>';
      return;
    }
    
    stations.forEach(function(station, index) {
      var card = document.createElement('div');
      card.className = 'card';
      card.onclick = function() { toggleStation(station.url, station.name, card); };
      
      var img = document.createElement('img');
      img.src = station.image;
      img.alt = station.name;
      img.onerror = function() {
        this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><rect width="140" height="140" fill="%231c1c1c"/><text x="50%" y="50%" font-family="Arial" font-size="14" fill="%23666" text-anchor="middle" dy=".3em">Radio</text></svg>';
      };
      
      var editBtn = document.createElement('div');
      editBtn.className = 'edit-btn';
      editBtn.innerHTML = '✎';
      editBtn.onclick = function(e) {
        e.stopPropagation();
        openEditModal(index);
      };
      
      card.appendChild(img);
      card.appendChild(editBtn);
      stationsGrid.appendChild(card);
    });
    
    var addCard = document.createElement('div');
    addCard.className = 'card add-card';
    addCard.innerHTML = '+';
    addCard.onclick = function() { openEditModal(-1); };
    stationsGrid.appendChild(addCard);
  }

  function openEditModal(index) {
    editingIndex = index;
    
    if (index === -1) {
      modalTitle.textContent = 'Добавить радиостанцию';
      document.getElementById('stationName').value = '';
      document.getElementById('stationImage').value = '';
      document.getElementById('stationUrl').value = '';
      deleteBtn.style.display = 'none';
    } else {
      modalTitle.textContent = 'Редактировать радиостанцию';
      document.getElementById('stationName').value = stations[index].name;
      document.getElementById('stationImage').value = stations[index].image;
      document.getElementById('stationUrl').value = stations[index].url;
      deleteBtn.style.display = 'inline-block';
    }
    
    editModal.style.display = 'flex';
  }

  function closeModal() {
    editModal.style.display = 'none';
  }

  function saveStation() {
    var name = document.getElementById('stationName').value;
    var image = document.getElementById('stationImage').value;
    var url = document.getElementById('stationUrl').value;
    
    if (!name || !url) {
      alert('Пожалуйста, заполните обязательные поля (название и URL потока)');
      return;
    }
    
    if (!image) {
      image = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><rect width="140" height="140" fill="%231c1c1c"/><text x="50%" y="50%" font-family="Arial" font-size="14" fill="%23666" text-anchor="middle" dy=".3em">Radio</text></svg>';
    }
    
    if (editingIndex === -1) {
      stations.push({ name, image, url });
    } else {
      stations[editingIndex] = { name, image, url };
    }
    
    saveStationsToCloud();
    renderStations();
    closeModal();
  }

  function deleteStation() {
    if (editingIndex !== -1 && confirm('Вы уверены, что хотите удалить эту радиостанцию?')) {
      stations.splice(editingIndex, 1);
      saveStationsToCloud();
      renderStations();
      closeModal();
      stopRadio();
    }
  }

  // Обработчики событий для iOS
  function setupIOSFix() {
    // Добавляем обработчики touch для всех интерактивных элементов
    const interactiveElements = document.querySelectorAll('.sleep-timer-btn, .card, .btn, .timer-action-btn');
    interactiveElements.forEach(el => {
      el.addEventListener('touchstart', function() {}, { passive: true });
      el.addEventListener('touchend', function() {}, { passive: true });
    });
    
    // Упрощенный скролл для iOS
    const timeScrolls = document.querySelectorAll('.time-scroll');
    timeScrolls.forEach(scroll => {
      scroll.addEventListener('touchstart', handleTimeScroll, { passive: false });
      scroll.addEventListener('touchmove', handleTimeScroll, { passive: false });
      scroll.addEventListener('touchend', handleTimeScroll, { passive: true });
    });
  }

  function handleTimeScroll(e) {
    e.preventDefault();
    const list = e.currentTarget.querySelector('.time-list');
    if (!list) return;
    
    if (e.type === 'touchstart') {
      list.startY = e.touches[0].clientY;
      list.currentY = parseInt(list.style.transform?.replace('translateY(', '').replace('px)', '') || '0');
    } else if (e.type === 'touchmove') {
      const deltaY = e.touches[0].clientY - list.startY;
      const newY = list.currentY + deltaY;
      list.style.transform = `translateY(${newY}px)`;
      updateActiveTimeItem(list, newY);
    } else if (e.type === 'touchend') {
      snapToNearest(list);
    }
  }

  // Инициализация при загрузке
  document.addEventListener('DOMContentLoaded', function() {
    loadStations();
    initTimeSelector();
    restoreSleepTimer();
    setupIOSFix();
    
    // Обработчики модальных окон
    if (editModal) {
      editModal.addEventListener('click', function(e) {
        if (e.target === editModal) {
          closeModal();
        }
      });
    }
    
    if (timerModal) {
      timerModal.addEventListener('click', function(e) {
        if (e.target === timerModal) {
          closeTimerModal();
        }
      });
    }
  });

  // Обработчики событий плеера
  player.addEventListener('waiting', function(){ 
    updatePlayStatus("буферизация..."); 
  });
  
  player.addEventListener('error', function(){ 
    updatePlayStatus("ошибка"); 
    if (currentActiveCard) {
      currentActiveCard.classList.remove('active');
      currentActiveCard = null;
      currentStationUrl = null;
    }
  });
</script>
</body>
</html>
